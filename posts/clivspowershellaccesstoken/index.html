<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Compare get-access-token and Get-AzAccessToken" /><meta name="author" content="Francois LEON" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://scomnewbie.github.io//posts/clivspowershellaccesstoken/" /><meta property="og:url" content="https://scomnewbie.github.io//posts/clivspowershellaccesstoken/" /><meta property="og:site_name" content="SCOMnewbie learnings" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-29T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Compare get-access-token and Get-AzAccessToken" /><meta name="twitter:site" content="@fanfleon" /><meta name="twitter:creator" content="@Francois LEON" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Francois LEON"},"description":"Introduction","url":"https://scomnewbie.github.io//posts/clivspowershellaccesstoken/","@type":"BlogPosting","headline":"Compare get-access-token and Get-AzAccessToken","dateModified":"2021-01-30T21:26:17+01:00","datePublished":"2021-01-29T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://scomnewbie.github.io//posts/clivspowershellaccesstoken/"},"@context":"https://schema.org"}</script><title>Compare get-access-token and Get-AzAccessToken | SCOMnewbie learnings</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-7JY58BKWDR"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-7JY58BKWDR'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">SCOMnewbie learnings</a></div><div class="site-subtitle font-italic">A text-focused Jekyll theme</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/SCOMnewbie" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/fanfleon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['francois.leon','hotmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG ‚Ä∫ <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Compare get-access-token and Get-AzAccessToken</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Compare get-access-token and Get-AzAccessToken</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jan 29, 2021, 12:00 AM +0100" > Jan 29 <i class="unloaded">2021-01-29T00:00:00+01:00</i> </span> by <span class="author"> Francois LEON </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Jan 30, 2021, 9:26 PM +0100" > Jan 30 <i class="unloaded">2021-01-30T21:26:17+01:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2653 words">14 min</span></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>Before going deeper in identity topics, I just wanted to play with this ‚Äúnew‚Äù Get-AzAccessToken. The Azure Powershell community was ‚Äúupset‚Äù because this command exists since a long time in CLI. This cmdlet belongs to the Az.Accounts module and has been released in November 2020. As I‚Äôve said in the previous article, my goal is to explain modern authentications and sadly this article won‚Äôt help, therefore I prefer to start with it. In this article, I will expose few ways to use the two commands (CLI and Ps) and give some general tips around identity.</p><h1 id="azure-cli">Azure CLI</h1><h2 id="basic-usage">Basic usage</h2><p>Once you‚Äôve <a href="https://docs.microsoft.com/fr-fr/cli/azure/install-azure-cli">installed the CLI</a>, it‚Äôs time to play a little with it:</p><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Don‚Äôt forget you can keep your <strong>CLI up to date automatically</strong> by simply typing <strong>az config set auto-upgrade.enable=yes</strong>. By default this setting is set to false.</div><p>Let‚Äôs generate an access token for Microsoft graph API and put it in clipboard</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c">#Once connected</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">login</span><span class="w">
</span><span class="c"># Let's generate a token for this context</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">get-access-token</span><span class="w"> </span><span class="nt">--resource</span><span class="w"> </span><span class="nx">https://graph.microsoft.com</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-Json</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">accessToken</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">clip</span><span class="w">
</span></pre></table></code></div></div><p>Let‚Äôs now paste this JWT token into <a href="https://jwt.ms/">jwt.ms</a>, go into the <strong>claims</strong> tab and check the <strong>appid</strong> property. You should see:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-01-29/02.png" alt="CLI VS Powershell 02" /></p><p>But wait we didn‚Äôt specified any clientId (AppId)? Remember last article? To establish a connection, you need an AppId, a redirectURL and scopes. Here we just type a command once logged in (az login). In fact this command is a wrapper (imagine like a Powershell function) which abstract a lot of parameters. Now this appId is in fact a well know clientId that Microsoft expose from their tenant. We will disscuss about how the app registration/Enterprise application concept if working.</p><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Powershell has also his own AppId. I use it in this <a href="https://github.com/SCOMnewbie/Azure/tree/master/DumpAADFromGuestUser">piece of code</a> where I explain how to dump an entiere tenant from a guest account if AAD is define with default security values.</div><p>If now we take a look at the scp property, we can see that <strong>scopes</strong> as already been defined:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-01-29/01.png" alt="CLI VS Powershell 01" /></p><p>We can see that without specifying any resources (scopes) we received a lot of permissions! As you can imagine, only delegated permissions are ‚Äúgranted‚Äù. Funny fact 1: Microsoft graph API do not expose user_impersonation scope compares to most of the other MS APIs. Funny fact 2: Check your AAD you won‚Äôt see an Enterprise app called CLI or Powershell within your tenant where we should but you have graph explorer üòä.</p><p>Let‚Äôs play and see what we can do with it! We can start with simple one, the /me endpoint:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c">#Use a basic user account to log in (non admin)</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">login</span><span class="w">
</span><span class="c">#Get a token for the audience https://graph.microsoft.com</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">az</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">get-access-token</span><span class="w"> </span><span class="nt">--resource</span><span class="w"> </span><span class="nx">https://graph.microsoft.com</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-Json</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">accessToken</span><span class="w">
</span><span class="c">#Generate a header</span><span class="w">
</span><span class="nv">$Headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$token</span><span class="w">
    </span><span class="s2">"Content-Type"</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/me"</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$Headers</span><span class="w">
</span></pre></table></code></div></div><p>It‚Äôs working and it‚Äôs normal because we have the <strong>User.ReadWrite.All permission</strong> in our <strong>scope</strong>. Here we‚Äôre simply say show me my user context. Now imagine you want to restrict the portal access to the basic users. You can easily do this from the <strong>Azure Active Directory</strong> tile and then <strong>User Settings</strong>. Let‚Äôs do it, and once done, now basic user can‚Äôt read applications (Enterprise and App registration) anymore.</p><p>You can find more information on how to play with applications REST api <a href="https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&amp;tabs=http">here</a>. if you check the permissions tab, we can see:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-01-29/03.png" alt="CLI VS Powershell 03" /></p><p>First, event if the application scope is not explicitely defined in our ‚Äúallowed‚Äù scope, we can see from the screenshot that the /applications endpoint allow you to query the url if you received the Directory.AccessAsUser.All scope which is the case here. Second, we can also see this scope is considered as <strong>most privileged</strong>.</p><p>This is where I consider Azure CLI or Powershell (see below) not helpful to understand modern authentications. There is so much abstraction done and do much ‚Äúpower‚Äù given to a basic user that I consider you lose the granularity modern authentication brings. But don‚Äôt get me wrong, I also totaly understand why Microsoft has decided to take those shortcuts (improve user experience).</p><p>Now the funny part, remember that <strong>our basic user can‚Äôt access the application anymore from the admin portal</strong> since we‚Äôve changed the user settings. But if you regenerate a token, guess what? It‚Äôs working because CLI give you the Directory.AccessAsUser.All scope‚Ä¶</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c">#Use a basic user account to log in (non admin)</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">az</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">get-access-token</span><span class="w"> </span><span class="nt">--resource</span><span class="w"> </span><span class="nx">https://graph.microsoft.com</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-Json</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">accessToken</span><span class="w">
</span><span class="nv">$Headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$token</span><span class="w">
    </span><span class="s2">"Content-Type"</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/applications"</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$Headers</span><span class="w">
</span></pre></table></code></div></div><div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> Instead of generate a token, construct the request and send it, CLI offer a shortcut. <strong>az rest ‚Äìuri https://graph.microsoft.com/v1.0/applications</strong>. CLI does exactly the same thing but in a oneliner.</div><p>In this first part, I wanted to explain that Microsoft did a good job to abstract the authentications complexity, but don‚Äôt forget those scopes are pretty permission wide. Here we‚Äôve requested an access token (AT) for the https://graph.microsoft.com audience but the CLI give you the possibility to generate an AT for the ARM fabric (https://manage.azure.com), or the old ms‚Äôgraph endpoint, Keyvault and so on‚Ä¶</p><h2 id="advanced-usage">Advanced usage</h2><p>If now we want to request only /applications endpoint and nothing else (why it‚Äôs another story, but let‚Äôs imagine lol). We will have to create an app registration (clientID/client secret), allow the specific scope and test! Let‚Äôs start by creating the App registration:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># Connect to CLI as at least application administrator AAD role</span><span class="w">
</span><span class="c">#Create my app, a secret without role assignment</span><span class="w">
</span><span class="nv">$MyApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">az</span><span class="w"> </span><span class="nx">ad</span><span class="w"> </span><span class="nx">sp</span><span class="w"> </span><span class="nx">create-for-rbac</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="s2">"getonlyapplications"</span><span class="w"> </span><span class="nt">--skip-assignment</span><span class="w">
</span></pre></table></code></div></div><p>For simplicity, let‚Äôs assign applications permission read only from the portal. Under your newly created app registration, you should now configure this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-01-29/04.png" alt="CLI VS Powershell 04" /></p><div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Important:</b> Make sure you choose <strong>delegated</strong> and <strong>not application</strong> permission!</div><p>Let‚Äôs now connect as our SP and query few things:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c"># Convert $Myapps to a usable object thx Powershell shell</span><span class="w">
</span><span class="nv">$Myapp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$myapp</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-Json</span><span class="w">
</span><span class="c">#Connect as the SP</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">login</span><span class="w"> </span><span class="nt">--service-principal</span><span class="w"> </span><span class="nt">--username</span><span class="w"> </span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">appId</span><span class="w"> </span><span class="nt">--password</span><span class="w"> </span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">password</span><span class="w"> </span><span class="nt">--tenant</span><span class="w"> </span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">tenant</span><span class="w"> </span><span class="nt">--allow-no-subscriptions</span><span class="w">
</span><span class="c">#We can now use the shortcut to contact our applications endpoint</span><span class="w">
</span><span class="nv">$Apps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">az</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="nt">--uri</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/applications"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-Json</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">value</span><span class="w">

</span><span class="c">#Here you should receive a forbidden message an it's normal</span><span class="w">
</span></pre></table></code></div></div><p>So what is happening? We will go deeper in another article, but we start to hit the limit of the CLI with custom api. If you check the <strong>expose an api</strong> menu, you should see:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-01-29/05.png" alt="CLI VS Powershell 05" /></p><p><strong>IMPORTANT CONCEPT:</strong></p><p>https://<your app="">/user_impersonation means that you allow this application to execute **delegated** actions on behalf of the user context. delegated means: **Only actions that user can do under his user context will be allowed through this clientId**. In other words, this is how you **make sure a user can break only things he owns and nothing else**. For example, a user will be able to add/remove members from the groups where he **has the owner privilege**. But here, at least from my knowledge, you can't do this from the CLI with the **basic commands** like **az login** and get-access-token (we will later, but with code behind). If you remember all the back and forth between your app and AAD (from the previous article), in this case your native app is the Azure CLI and you don't have a way to use a redirectURI for example.</your></p><p>Ok so let‚Äôs ‚Äúfix‚Äù our current issue. We know that we can‚Äôt do impersonation. Let‚Äôs stick <strong>to application instead of delegated permission</strong>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-01-29/06.png" alt="CLI VS Powershell 06" /></p><p>And now we will be able to execute our action this time not on behalf of a user but as a <strong>daemon/Service Principal</strong>. <strong>Application permission</strong> can be dangerous when you don‚Äôt understand what you‚Äôre doing. You can assign high permissions and you won‚Äôt be able to track who do what when which can be a security risk. This is global admins mandate to understand this part.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c">#Reconnect to generate a new token with the new permission</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">login</span><span class="w"> </span><span class="nt">--service-principal</span><span class="w"> </span><span class="nt">--username</span><span class="w"> </span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">appId</span><span class="w"> </span><span class="nt">--password</span><span class="w"> </span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">password</span><span class="w"> </span><span class="nt">--tenant</span><span class="w"> </span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">tenant</span><span class="w"> </span><span class="nt">--allow-no-subscriptions</span><span class="w">
</span><span class="c">#can we use the same URL this time?</span><span class="w">
</span><span class="nv">$Apps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">az</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="nt">--uri</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/applications"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-Json</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">value</span><span class="w">
</span><span class="c"># Yes! Let's now generate an AT and do the same thing</span><span class="w">
</span><span class="nv">$token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">az</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">get-access-token</span><span class="w"> </span><span class="nt">--resource</span><span class="w"> </span><span class="nx">https://graph.microsoft.com/</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-Json</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">accessToken</span><span class="w">
</span><span class="nv">$Headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$token</span><span class="w">
    </span><span class="s2">"Content-Type"</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/applications"</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$Headers</span><span class="w">
</span><span class="c">#If now we decide to change the endpoint to /me (remember, it worked before)</span><span class="w">
</span><span class="nv">$uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/me"</span><span class="w">
</span><span class="c">#Now you have an access denied which is normal because your clientID only expose the application.read.all scope</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$Headers</span><span class="w">
</span></pre></table></code></div></div><p>If you now paste your AT in jwt.ms, you will see this time under the roles property that only the application.read.all permission is exposed.</p><p>Here another thing that I don‚Äôt really like in this experience which makes the whole modern auth topic fuzzy. Instead of typing https://graph.microsoft.com/.default or https://graph.microsoft.com/Application.Read.All, we type https://graph.microsoft.com/ only which is inaccurate. But if you try to type the 2 others, you will receive an error message where you shouldn‚Äôt.</p><p>If you want more information about the ./default endpoint, you can find more information <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent">here</a>.</p><h2 id="summary">Summary</h2><p>We can do a lot of fun things with the Azure CLI, MS did a great job to abstract the complexity,but I don‚Äôt think this is how I will be able to explain how modern authentication is working.</p><h1 id="azure-powershell">Azure Powershell</h1><h2 id="introduction-1">Introduction</h2><p>Let‚Äôs now switch to Azure Powershell. Since few months now, we now have a module that is using the MSAL library (compared to CLI which still rely on ADAL). <strong>MSAL is a library to generate tokens in OIDC/OAUTH 2.0 world</strong> (ADAL will be deprecated in June 2020). Within the Az.Accounts module we have this cmdlet called Get-AzAccessToken, let‚Äôs try to have some fun with it.</p><h2 id="basic-usage-1">Basic usage</h2><p>Let‚Äôs start by listing all the resource groups we have in our Azure subscription. Of course, the account you will use when you will do you Connect-AzAccount need to have at least <strong>reader access</strong> (or more restricted access if you want to be the ‚Äúclass delegate‚Äù‚Ä¶)</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="c">#Once connected with an account (not a service Principal)</span><span class="w">
</span><span class="n">Connect-azaccount</span><span class="w">
</span><span class="c">#Let's generate an access token to the ARM fabric audience and make it a bearer token</span><span class="w">
</span><span class="nv">$Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Bearer {0}"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AzAccessToken</span><span class="w"> </span><span class="nt">-Resource</span><span class="w"> </span><span class="s2">"https://management.azure.com"</span><span class="p">)</span><span class="o">.</span><span class="nf">Token</span><span class="w">
</span><span class="c">#Let's define our subscriptionId</span><span class="w">
</span><span class="nv">$subId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;your sub Id&gt;"</span><span class="w">
</span><span class="c"># Define our URI</span><span class="w">
</span><span class="nv">$Uri</span><span class="w"> </span><span class="s2">"https://management.azure.com/subscriptions/</span><span class="nv">$subId</span><span class="s2">/resourcegroups?api-version=2020-06-01"</span><span class="w">
</span><span class="c">#Create the header as before</span><span class="w">
</span><span class="nv">$Headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$token</span><span class="w">
    </span><span class="s2">"Content-Type"</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c"># And let's call the endpoint</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$Headers</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w">
</span><span class="c"># You should now see all resource groups your users can see in the subscription</span><span class="w">
</span><span class="c">#Let's now imagine you have a Keyvault already created (in RBAC mode) and you want to store a new secret, lets try!</span><span class="w">
</span><span class="nv">$uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://&lt;your vault&gt;.vault.azure.net/secrets/&lt;your secret name&gt;?api-version=7.1"</span><span class="w">
</span><span class="c">#Let's now create a body that will contains your password</span><span class="w">
</span><span class="nv">$Body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MySuperSecret"</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertTo-Json</span><span class="w">
</span><span class="c">#Let's now call our Keyvault endpoint</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$Headers</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">PUT</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="nv">$body</span><span class="w">
</span><span class="c">#You should now receive an error regarding the wrong audience and it's normal. Don't forget that previously, we've generated an AT why the https://management.azure.com audience.</span><span class="w">
</span><span class="c"># Keyvault is using another one. Let's generate a new token with the proper audience. You can use this:</span><span class="w">
</span><span class="nv">$Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Bearer {0}"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AzAccessToken</span><span class="w"> </span><span class="nt">-ResourceTypeName</span><span class="w"> </span><span class="nx">KeyVault</span><span class="p">)</span><span class="o">.</span><span class="nf">Token</span><span class="w">
</span><span class="c">#or the previous method if you prefer</span><span class="w">
</span><span class="nv">$Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Bearer {0}"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AzAccessToken</span><span class="w"> </span><span class="nt">-Resource</span><span class="w"> </span><span class="s2">"https://vault.azure.net"</span><span class="p">)</span><span class="o">.</span><span class="nf">Token</span><span class="w">
</span><span class="c">#Regenerate the hearders</span><span class="w">
</span><span class="nv">$Headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$token</span><span class="w">
    </span><span class="s2">"Content-Type"</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c">#You're good to go</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$Headers</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w">
</span><span class="c"># Now you have a new secret stored in our Keyvault</span><span class="w">
</span></pre></table></code></div></div><p>Like CLI, Azure Powershell abstract all redirectURI, scopes, clientID, to get your AT. Do you think like AZ CLI, Azure Powershell has his own invoke rest method? Let‚Äôs see!</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c">#Let's see what do we have</span><span class="w">
</span><span class="n">get-command</span><span class="w"> </span><span class="nt">-noun</span><span class="w"> </span><span class="o">*</span><span class="nx">rest</span><span class="o">*</span><span class="w"> </span><span class="nt">-module</span><span class="w"> </span><span class="nx">az.</span><span class="o">*</span><span class="w">
</span><span class="c"># Yeah Invoke-AzRestMethod ! Let's try as before with CLI</span><span class="w">
</span><span class="n">Invoke-AzRest</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/users"</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w">
</span><span class="c">#You should receive a weird error message like API version is mandatory ...</span><span class="w">
</span><span class="c">#If you check the help, you will see that this command is only for ARM endpoint, not graph.</span><span class="w">
</span><span class="n">help</span><span class="w"> </span><span class="nx">Invoke-AzRest</span><span class="w"> </span><span class="nt">-online</span><span class="w">
</span><span class="c">#If this time we try an ARM URI has the example propose</span><span class="w">
</span><span class="n">Invoke-AzRest</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"/subscriptions/</span><span class="nv">$subId</span><span class="s2">/resourcegroups?api-version=2020-06-01"</span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w">
</span><span class="c">#You should now receive your data</span><span class="w">
</span></pre></table></code></div></div><p>To sumarise this basic part, as always, the Azure Powershell experience seems behind the CLI but for basic actions we can rely on it.</p><h2 id="advanced-usage-1">Advanced usage</h2><p>We will use the same application that we‚Äôve previously created.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c">#Create a PSCredential object</span><span class="w">
</span><span class="nv">$Encryptedpassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">password</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="nv">$credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="w"> </span><span class="p">(</span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">appId</span><span class="p">,</span><span class="w"> </span><span class="nv">$Encryptedpassword</span><span class="p">)</span><span class="w">
</span><span class="c">#Let's now connect to my tenant as a service principal</span><span class="w">
</span><span class="n">Connect-AzAccount</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$credential</span><span class="w"> </span><span class="nt">-Tenant</span><span class="w"> </span><span class="nv">$MyApp</span><span class="o">.</span><span class="nf">tenant</span><span class="w"> </span><span class="nt">-ServicePrincipal</span><span class="w">
</span><span class="c">#Remember this application only have the possibility to list applications through graph API audience. So let's do something dummy like generating a token for the ARM audience instead of graph</span><span class="w">
</span><span class="nv">$Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Bearer {0}"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AzAccessToken</span><span class="w"> </span><span class="nt">-Resource</span><span class="w"> </span><span class="s2">"https://management.azure.com"</span><span class="p">)</span><span class="o">.</span><span class="nf">Token</span><span class="w">
</span><span class="c">#Defin the URI you want to reach</span><span class="w">
</span><span class="nv">$Uri</span><span class="w"> </span><span class="s2">"https://management.azure.com/subscriptions/</span><span class="nv">$subId</span><span class="s2">/resourcegroups?api-version=2020-06-01"</span><span class="w">
</span><span class="c"># And try to get your resource group</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-ContentType</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="p">@{</span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$token</span><span class="p">}</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w">
</span><span class="c"># This time, you should receive a message telling you that this application &lt;ClientID&gt; does not have the right to do action on Microsoft.Resources/subscriptions/resourcegroups/read and it's normal</span><span class="w">
</span><span class="c">#Let's now generate a token this time for the proper audience</span><span class="w">
</span><span class="nv">$Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Bearer {0}"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AzAccessToken</span><span class="w"> </span><span class="nt">-Resource</span><span class="w"> </span><span class="nx">https://graph.microsoft.com/</span><span class="p">)</span><span class="o">.</span><span class="nf">Token</span><span class="w">
</span><span class="nv">$uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/applications"</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-ContentType</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="p">@{</span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$token</span><span class="p">}</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w">
</span><span class="c"># And this time you should be able to list your applications. For fun let's try to list /users because we have the proper audience and the Az Powershell magic abstraction, we don't have to regenrate a token</span><span class="w">
</span><span class="nv">$uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/v1.0/users"</span><span class="w">
</span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-ContentType</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="p">@{</span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$token</span><span class="p">}</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">get</span><span class="w">
</span><span class="c">#And you should have an access denied which is normal because this application is allowed to list only applications</span><span class="w">
</span></pre></table></code></div></div><h2 id="summary-1">Summary</h2><p>We have almost the same experience with the Az Powershell except the Invoke-restmethod which require more work to compete the CLI.</p><h1 id="conclusion">Conclusion</h1><p>The purpose of this article wasn‚Äôt to explain how modern authentication is working because as I‚Äôve tried to demonstrate a lot of abstraction is made by Microsoft to help the user experience. Here few take away from this article:</p><ul><li>Understand the difference between <strong>delegated Vs application permission</strong> is critical.<li>An access token is generated to an <strong>audience</strong>. You can‚Äôt use this token to contact another audience. It will be clearer when we will create our custom API.<li><strong>Scopes</strong> are also an important part. As I‚Äôve tried to explain here, those tools do a lot of abstraction. Later we will see that you can‚Äôt even have an AT if you don‚Äôt specific a scope.</ul><p>There is far more to cover regarding identity, as you will see it‚Äôs a wide playground where we can learn a lot of things! See you in the next one.</p><div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> If you use a lot of Az CLI or Powershell another take away can be to abuse the ‚Äìdebug or -debug when you type a command. For example Get-AzResourceGroup -Debug will give you all requests that is done in the backend. Pretty useful from time to time</div><h1 id="references">references</h1><p><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-migration">ADAL Vs MSAL</a></p><p><a href="https://docs.microsoft.com/en-us/graph/api/overview?view=graph-rest-1.0">Graph API rest reference</a></p><p><a href="https://docs.microsoft.com/en-us/rest/api/azure/">Azure rest reference</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/identity/'>identity</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/identity/" class="post-tag no-text-decoration" >identity</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >Powershell</a> <a href="/tags/cli/" class="post-tag no-text-decoration" >CLI</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Compare get-access-token and Get-AzAccessToken - SCOMnewbie learnings&url=https://scomnewbie.github.io//posts/clivspowershellaccesstoken/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Compare get-access-token and Get-AzAccessToken - SCOMnewbie learnings&u=https://scomnewbie.github.io//posts/clivspowershellaccesstoken/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Compare get-access-token and Get-AzAccessToken - SCOMnewbie learnings&url=https://scomnewbie.github.io//posts/clivspowershellaccesstoken/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/usegraphapibatching/">Use Graph API batching to speed things up?</a><li><a href="/posts/adqueriesfromazure/">Execute AD queries protected by modern authentication from Azure without VPN</a><li><a href="/posts/createaadapplications/">Another way to create Azure AD applications</a><li><a href="/posts/passwordlesswitharc/">Passwordless deployment from anywhere with Azure ARC</a><li><a href="/posts/registrationvsenterpriseapp/">Deep dive into modern application</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/identity/">identity</a> <a class="post-tag" href="/tags/aad/">AAD</a> <a class="post-tag" href="/tags/azuread/">AzureAD</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/cli/">CLI</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/devops/">Devops</a> <a class="post-tag" href="/tags/graph/">Graph</a> <a class="post-tag" href="/tags/graphapi/">GraphAPI</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/apiwithpode/"><div class="card-body"> <span class="timeago small" > Jul 7 <i class="unloaded">2021-07-07T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Build a Powershell API with Pode</h3><div class="text-muted small"><p> Introduction I‚Äôve tried to explain previously how to secure a backend api where I‚Äôve used Azure functions to demonstrate how to protect it, but what if we‚Äôre not on Azure? I know you can run the A...</p></div></div></a></div><div class="card"> <a href="/posts/adqueriesfromazure/"><div class="card-body"> <span class="timeago small" > Jul 28 <i class="unloaded">2021-07-28T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Execute AD queries protected by modern authentication from Azure without VPN</h3><div class="text-muted small"><p> Introduction I have this question in mind since several months‚Ä¶ What would I do if I wanted to run Active Directory (AD) queries from Azure without a VPN gateway? Basically, I wanted to do a quick...</p></div></div></a></div><div class="card"> <a href="/posts/passwordlesswitharc/"><div class="card-body"> <span class="timeago small" > Feb 19 <i class="unloaded">2021-02-19T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Passwordless deployment from anywhere with Azure ARC</h3><div class="text-muted small"><p> Introduction Instead of re-inventing the wheel, I will simply paste this definition that I‚Äôve found in the Azure ARC overview. ‚ÄúAzure Arc enables you to manage your entire environment, with a sing...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/moderauth/" class="btn btn-outline-primary"><p>What modern authentication is?</p></a> <a href="/posts/registrationvsenterpriseapp/" class="btn btn-outline-primary"><p>Deep dive into modern application</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> ¬© 2021 <a href="https://twitter.com/fanfleon">Francois LEON</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/identity/">identity</a> <a class="post-tag" href="/tags/aad/">AAD</a> <a class="post-tag" href="/tags/azuread/">AzureAD</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/cli/">CLI</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/devops/">Devops</a> <a class="post-tag" href="/tags/graph/">Graph</a> <a class="post-tag" href="/tags/graphapi/">GraphAPI</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://scomnewbie.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
