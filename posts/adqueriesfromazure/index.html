<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Execute AD queries protected by modern authentication from Azure without VPN" /><meta name="author" content="Francois LEON" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://scomnewbie.github.io//posts/adqueriesfromazure/" /><meta property="og:url" content="https://scomnewbie.github.io//posts/adqueriesfromazure/" /><meta property="og:site_name" content="SCOMnewbie learnings" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-28T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Execute AD queries protected by modern authentication from Azure without VPN" /><meta name="twitter:site" content="@fanfleon" /><meta name="twitter:creator" content="@Francois LEON" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Francois LEON"},"description":"Introduction","url":"https://scomnewbie.github.io//posts/adqueriesfromazure/","@type":"BlogPosting","headline":"Execute AD queries protected by modern authentication from Azure without VPN","dateModified":"2021-07-29T20:59:25+02:00","datePublished":"2021-07-28T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://scomnewbie.github.io//posts/adqueriesfromazure/"},"@context":"https://schema.org"}</script><title>Execute AD queries protected by modern authentication from Azure without VPN | SCOMnewbie learnings</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-7JY58BKWDR"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-7JY58BKWDR'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">SCOMnewbie learnings</a></div><div class="site-subtitle font-italic">A text-focused Jekyll theme</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/SCOMnewbie" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/fanfleon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['francois.leon','hotmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Execute AD queries protected by modern authentication from Azure without VPN</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Execute AD queries protected by modern authentication from Azure without VPN</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 28, 2021, 12:00 AM +0200" > Jul 28 <i class="unloaded">2021-07-28T00:00:00+02:00</i> </span> by <span class="author"> Francois LEON </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Jul 29, 2021, 8:59 PM +0200" > Jul 29 <i class="unloaded">2021-07-29T20:59:25+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1905 words">10 min</span></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>I have this question in mind since several months… What would I do if I wanted to run Active Directory (AD) queries from Azure without a VPN gateway? Basically, I wanted to do a quick Proof Of Concept (POC) with the <a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-hybrid-connections">hybrid connector (HBC) for app service</a>. PS Remoting with HBC over azure function (Windows Operating system) <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-hybrid-powershell">is not new</a>. But because I like challenges (or because I’m stupid…) I’ve decided to test with a app service hosted on a Linux OS since the feature is <a href="https://azure.microsoft.com/en-us/updates/azure-app-service-hybrid-connections-for-linux-apps-is-now-available">GA</a>. In other words, the plan will be to use a <strong>Powershell Linux container</strong> hosted on an app service, enable the <strong>hybrid connector</strong>, do a <strong>PS remoting session</strong> on an on-premises domain joined Windows box to finally reach Active Directory… What could go wrong?</p><p>You can find the code <a href="https://github.com/SCOMnewbie/psoauth2/tree/main/Examples/Powershell/10-WebAPI-HybridConnector">here</a>.</p><p>The idea looks like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/idea.png" alt="idea" /></p><p>During this article, we will:</p><ul><li>implement the solution<li>then show it in action<li>next explain why I’ve spent far more hours than I’ve thought for this POC<li>conclude with cost explanation because this POC is not free</ul><h1 id="implementation">Implementation</h1><h2 id="step1--prepare-the-remote-machine-on-premises">Step1 – Prepare the remote machine (on premises)</h2><p>This machine <strong>must be domain joined</strong>. According to the hybrid connector documentation, the machine has to be at least a Windows 2012, I’ve personally used a Windows 10 machine.</p><p>Let’s now enable the feature <strong>Powershell AD management tools</strong>.</p><p>Next, we will have to create a <strong>winrm HTTPS listener</strong> which allow <strong>basic authentication</strong> (<strong>winrm set winrm/config/service/auth ‘@{Basic=”true”}’</strong>). There is a lot of documentation around this topic. I think I’ve followed this <a href="https://cloudblogcenter.com/2020/05/23/using-azure-hybrid-connections-in-azure-functions">one</a>. After several fails with NTLM, I’ve decided to go the basic authentication way over HTTPS. It works with NTLM when you use Azure function, I guess it should work with Linux too. But I never succeed to make it work.</p><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> I’ve used a self-signed certificate during this POC.</div><p>Next, we will create a <strong>new local admin account</strong>. Local admin because this is the quickest way to use PS remoting sessions. I’m sure there is tutorials to allow non-admin users to connect.</p><p>That’s it for now, we will come back later on this machine.</p><h2 id="step2--configure-the-azure-infrastructure">Step2 – Configure the Azure infrastructure</h2><p>Nothing complicated here, I’ve created a <strong>Linux Docker container S1 SKU App service</strong> and a <strong>basic ACR</strong> (container registry) in the same region.</p><p>Then, I’ve added 2 configurations in the web app’s app settings:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/appsettings.png" alt="appsettings" /></p><p>This represents the credentials (local creds previously created) that our web app will use to <strong>instantiate the remote session to the on prem machine</strong>. Doing this avoid hardcoding login/password into the script. As usual, a more secure approach is to use a Keyvault and a reference link.</p><p>Once the App Service is created, go to network and configure the hybrid connector once done (follow the doc), don’t forget to <strong>download the agent</strong> (Download connection manager) we will install it just after.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/hbc.png" alt="hbc" /></p><h2 id="step3--back-to-the-remote-machine-on-premises">Step3 – Back to the remote machine (on premises)</h2><p>It’s time to <strong>install the hybrid agent</strong> we’ve previously downloaded. Simple to install, next, next sign-ins with your AAD account and you should be connected:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/hbcmanager.png" alt="hbcmanager" /></p><p>The last step is to <strong>store your corporate password encrypted with a specific key</strong> (more info later). Here the code you can use on the device to protect your password:</p><pre><code class="language-Powershell">#Generate a random 256 bit AES key
$Key = New-Object Byte[] 32
[Security.Cryptography.RNGCryptoServiceProvider]::Create().GetBytes($Key)
#Flat the key and put it into the clipboard
$key | %{$str += "$_," } ; $str.Substring(0,$str.Length -1) | clip
#Generate the encrypted password file with the previously created key and store it into a specific path (change with your path).
"your password" | ConvertTo-SecureString -AsPlainText -Force | ConvertFrom-SecureString -Key $key | Out-File 'C:\TEMP\secret.txt'

# Create a PSCredential from the encrypted file with the key (Re-hydrate)
# $OrgCreds = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList 'Corp SamAccountName', (Get-Content 'C:\TEMP\secret.txt' | ConvertTo-SecureString -Key $key)
# Get-aduser "blabla" -credential $Orgcreds

</code></pre><p><strong>Keep the $Key in your clipboard</strong> you will need it later. We’re done with this machine, let’s built our API hosted in the cloud!</p><h2 id="step4---build-our-api">Step4 - Build our API</h2><p>For simplicity, I’ve used the same AAD application I’ve created in the previous article where I have app roles defined (read.access, write.access, admin.access) in my app registration. I will use almost the same code as before for the startpode.ps1. Long story short, I’ve kept the Pode Middleware configuration, removed the previously created routes and added a route called ‘/api/readfromhybrid’ where the $ReadAccessRequired middleware make sure your token is valid and your user authorized to consume this API. If need more information, you can have more info <a href="https://scomnewbie.github.io/posts/apiwithpode/">here</a>.</p><p>Changes in startpode.ps1 compared to last article:</p><ul><li>On top of the file, we now import a new module called <strong>PSWSMAN</strong> and we execute the command <strong>Disable-WSManCertVerification -All</strong>. As the name suggest and because we use self-signed certs, we will have to disable both CA/CN checks.<li>Line 12/13 we just fetch the local creds exposed in the app settings.<li>I removed all previous routes and added one ‘/api/readfromhybrid’.</ul><p>Let’s explain the code of the route:</p><pre><code class="language-Powershell">$SamAccountName = $WebEvent.Query['samaccountname']

$Script = {
    param($SamAccountName)
    # AES key that has been generated from the target machine (hardcoded for this POC, replace with your clipboard value)
    [Byte[]]$Key = @(214,234,128,193,229,128,66,17,101,143,108,66,153,101,6,206,34,149,225,88,255,29,161,70,47,47,99,224,230,46,4,73)
    # Rehydrate the PSCredential with hardcoded myorgaccount (use your AD service account here) and the encrypted password file located on the remote host
    $OrgCreds = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList 'myorgaccount', (Get-Content 'C:\TEMP\secret.txt' | ConvertTo-SecureString -Key $Key)
    #Then do a simple get AD user with a query parameter
    get-aduser $SamAccountName -Credential $OrgCreds
}

# Use the local remote local creds to generate a pssession and send the scriptblock script trough the HTTPS listener
$creds = [system.management.automation.pscredential]::new($Using:UserName,$Using:Password)
$Data = invoke-command -ComputerName "&lt;Hybrid Endpoint Name (machine name)&gt;" -Authentication Basic -Credential $creds -Port 5986 -UseSSL -ScriptBlock $Script -ArgumentList $SamAccountName

# Should have a better token validation here
Write-PodeJsonResponse -Value $Data

</code></pre><ul><li>Line 172 - This API is waiting for a <strong>query parameter</strong> called samaccountname. This parameter will be passed to the remote machine.<li>Line 174 To 182 - We define a <strong>scriptblock that will be executed on the remote machine</strong>. Instead of hardcoding the corporate credential into the container (possible security issue), I’ve hardcoded the previously created AES key (the one you should have into your clipboard). Of course, you can use KV/App settings again, I know that’s not a perfect solution but after all the pain (see later), I’ve decided to take this shortcut. Line 179, I simply re-hydrate the PSCredential on the remote machine and then do a get-ADUser…<li>Line 184-185 - We “simply” do an <strong>invoke-command</strong> with the local remote machine credentials and pass both the scriptblock and the HTTP query parameter. Because our container is not domain joined, I’ve decided to use the basic authentication (therefore you have to enable it in step1) over HTTPS. This is where the <strong>hybrid connector Blackmagic</strong> happen!<li>Line 189 - <strong>return the data received over the 443 TCP port</strong> from the remote machine (I’m still amazed by this feature), of course error handling should be implemented here.</ul><h1 id="in-action">In action</h1><p>Create your image from the dockerfile</p><pre><code class="language-Powershell">docker build -t funwithhybrid .
</code></pre><p>Then tag your container to match your ACR name</p><pre><code class="language-Powershell">Docker tag funwithhybrid:latest "&lt;your ACR name&gt;.azurecr.io/funwithhybrid:latest"
</code></pre><p>Then sign-in to your ACR</p><pre><code class="language-Powershell">az acr login -n 'your ACR name'
</code></pre><p>And finally push your container to your ACR</p><pre><code class="language-Powershell">docker push 'your ACR name'.azurecr.io/funwithhybrid:latest
</code></pre><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Bad note for Microsoft regarding the admins credential you HAVE TO enable them on your ACR if you plan to use app service for containers. I hope Microsoft will enable the managed Identity feature soon.</div><p>Now you have your container in the ACR, configure your app service to use your image:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/webapp.png" alt="webapp" /></p><p>Once your site is up and running, you can take your preferred API client in my case Thunder client VS Code extension and call your API **https://<Your app="" service="" name="">.azurewebsites.net/api/readfromhybrid?samaccountname=<your SamAccountName="">**.</your></Your></p><p>Because it’s <strong>AAD protected</strong> (this part is covered in the multiple articles that I’ve published already), if I try with an expired JWT token, I receive:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/expired.png" alt="expired" /></p><p>If now I use a valid token:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/validtoken.png" alt="valid" /></p><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> For this POC, my remote endpoint is a remote machine connected to a domain controller via VPN because why not… In other words, the flow goes from the web app to the hybrid connector (Service Bus) to my laptop connected to a remote DC trough VPN. In addition, I have several apps running already on this cheap app service plan. This is why (I hope) it’s not uncommon to wait more than 10 seconds … But it works!</div><p>I can run AD queries from a Linux container protected with Azure Active Directory without VPN. <strong>Challenge completed</strong>!</p><p>Now let’s explain why I’ve spent more than 8 hours to make it works…</p><h1 id="the-pains">The pains</h1><h2 id="pain1--ps-remoting-over-wsman-on-linux">Pain1 – PS Remoting over WSMAN on Linux</h2><p>The <strong>PS Remoting over WSWAN on a Linux</strong> machine was a big pain. PS Team recommends using SSH today, but I can’t use SSH in this case. Quickly I’ve found this <a href="https://www.bloggingforlogging.com/2020/08/21/wacky-wsman-on-linux/">article</a> where <strong>Jordan Borean</strong> explains the reason of my multiple fails… A big thank you to him for both this article who popularizes this complicated topic and for the <a href="https://github.com/jborean93/omi">PSWSMAN module</a>.</p><h2 id="pain2--re-hydrate-the-credentials-on-the-remote-machine">Pain2 – Re-hydrate the credentials on the remote machine</h2><p>My first try was to use Azure ARC and <a href="https://github.com/SCOMnewbie/Azure/blob/master/Identity-AAD/New-ARCAccessTokenMSI.ps1">my function</a> to retrieve credentials from Keyvault with the local MSI endpoint. Sadly the ARC agent is running under the network context and not the local user one. In other words, I never succeed to fetch an access token. Then my second idea was to use a ConvertTo-Securestring with CLIXML commands, sadly the Hybrid agent is running in a different context again … Therefore, I’ve decided to generate my own AES key and then use it to encrypt/decrypt a file. User context doesn’t matter in this case.</p><h2 id="pain3--lack-of-debugging">Pain3 – Lack of debugging</h2><p>Between Docker, Pode, Azure web app, the Hybrid Connector and finally the remote machine itself, trust me that I’ve created a LLLOOOTTT of containers before the solution be a success … The lack of logs was real.</p><h1 id="cost">Cost</h1><p>This POC is not free of charge.</p><h2 id="hybrid-connector">Hybrid Connector</h2><p>It cost me 0.50 € for a week. When you look at the doc, you can see:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/price1.png" alt="price1" /></p><p>It’s still far cheaper than even the smaller VPN GW you can configure.</p><h2 id="container-registry">Container Registry</h2><p>It cost me 0,7 € and I’ve used the basic SKU without egress or build time. From the doc you can see:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/price2.PNG" alt="price2" /></p><h2 id="app-service-plan">App Service Plan</h2><p>To use the hybrid connector, you <strong>can’t use the consumption tier</strong> but instead the Standard and above. I’ve decided to use the S1 (cheapest in my case) which cost me something like 10 € for the week. When you check the doc, you can see:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-07-28/price3.png" alt="price3" /></p><p>I personally run several apps on this app service plan so the cost is not “crazy”.</p><h1 id="conclusion">Conclusion</h1><p>As a big fan of JEA (Just Enough Admin) endpoints, where you can control who can access to what (among other things) but <strong>only from an AD domain</strong>, now I know I can bring <strong>Azure AD and modern authentication</strong> to the picture too. When you think about it, controlling an on-premises PS endpoint from Azure is cool don’t you think? If you plan for intensive requests on AD, I guess the VPN should be a better option. At least it can be an interesting test to do.</p><p>Anyway, before closing this article, I wanted to thank again both <strong>Jordan Borean</strong> for his amazing work on the PSWSMAN module and <strong>Matthew Kelly</strong> for his wonderful Pode module.</p><p>See you for the next one.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/powershell/'>powershell</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/identity/" class="post-tag no-text-decoration" >identity</a> <a href="/tags/aad/" class="post-tag no-text-decoration" >AAD</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >Powershell</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Execute AD queries protected by modern authentication from Azure without VPN - SCOMnewbie learnings&url=https://scomnewbie.github.io//posts/adqueriesfromazure/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Execute AD queries protected by modern authentication from Azure without VPN - SCOMnewbie learnings&u=https://scomnewbie.github.io//posts/adqueriesfromazure/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Execute AD queries protected by modern authentication from Azure without VPN - SCOMnewbie learnings&url=https://scomnewbie.github.io//posts/adqueriesfromazure/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/usegraphapibatching/">Use Graph API batching to speed things up?</a><li><a href="/posts/adqueriesfromazure/">Execute AD queries protected by modern authentication from Azure without VPN</a><li><a href="/posts/createaadapplications/">Another way to create Azure AD applications</a><li><a href="/posts/passwordlesswitharc/">Passwordless deployment from anywhere with Azure ARC</a><li><a href="/posts/registrationvsenterpriseapp/">Deep dive into modern application</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/identity/">identity</a> <a class="post-tag" href="/tags/aad/">AAD</a> <a class="post-tag" href="/tags/azuread/">AzureAD</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/cli/">CLI</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/devops/">Devops</a> <a class="post-tag" href="/tags/graph/">Graph</a> <a class="post-tag" href="/tags/graphapi/">GraphAPI</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/createaadapplications/"><div class="card-body"> <span class="timeago small" > Mar 24 <i class="unloaded">2021-03-24T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Another way to create Azure AD applications</h3><div class="text-muted small"><p> Introduction I’m still enjoying learning AAD identity topics. In the previous articles, I’ve explained the differences between app registration and Enterprise app. Since I’ve started this learning...</p></div></div></a></div><div class="card"> <a href="/posts/howtousemodernauth/"><div class="card-body"> <span class="timeago small" > Jun 9 <i class="unloaded">2021-06-09T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to use modern authentication</h3><div class="text-muted small"><p> Introduction I’m learning modern authentications since several months and I still learn new things every day! I’m super happy to publicly share what I’m doing on my free time and I hope it will he...</p></div></div></a></div><div class="card"> <a href="/posts/protectbackendapi/"><div class="card-body"> <span class="timeago small" > Jun 18 <i class="unloaded">2021-06-18T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Play with multitier AAD applications</h3><div class="text-muted small"><p> Introduction Now that we covered basics in the previous article, let’s go a step higher and build a multi-tiers application composed in our case with a frontend (Powershell console) and a backend ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/apiwithpode/" class="btn btn-outline-primary"><p>Build a Powershell API with Pode</p></a> <a href="/posts/usegraphapibatching/" class="btn btn-outline-primary"><p>Use Graph API batching to speed things up?</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/fanfleon">Francois LEON</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/identity/">identity</a> <a class="post-tag" href="/tags/aad/">AAD</a> <a class="post-tag" href="/tags/azuread/">AzureAD</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/cli/">CLI</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/devops/">Devops</a> <a class="post-tag" href="/tags/graph/">Graph</a> <a class="post-tag" href="/tags/graphapi/">GraphAPI</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://scomnewbie.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
