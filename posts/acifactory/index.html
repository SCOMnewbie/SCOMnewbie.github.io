<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Kubernetes is not the only way…" /><meta name="author" content="Francois LEON" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://scomnewbie.github.io//posts/acifactory/" /><meta property="og:url" content="https://scomnewbie.github.io//posts/acifactory/" /><meta property="og:site_name" content="SCOMnewbie learnings" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-29T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Kubernetes is not the only way…" /><meta name="twitter:site" content="@fanfleon" /><meta name="twitter:creator" content="@Francois LEON" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Francois LEON"},"description":"Introduction","url":"https://scomnewbie.github.io//posts/acifactory/","@type":"BlogPosting","headline":"Kubernetes is not the only way…","dateModified":"2021-08-29T00:00:00+02:00","datePublished":"2021-08-29T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://scomnewbie.github.io//posts/acifactory/"},"@context":"https://schema.org"}</script><title>Kubernetes is not the only way... | SCOMnewbie learnings</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-7JY58BKWDR"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-7JY58BKWDR'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">SCOMnewbie learnings</a></div><div class="site-subtitle font-italic">A text-focused Jekyll theme</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/SCOMnewbie" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/fanfleon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['francois.leon','hotmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Kubernetes is not the only way...</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Kubernetes is not the only way...</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Aug 29, 2021, 12:00 AM +0200" > Aug 29 <i class="unloaded">2021-08-29T00:00:00+02:00</i> </span> by <span class="author"> Francois LEON </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2312 words">12 min</span></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>Before people start to bash me, I just want to clarify few things. I’m not pros or cons Kubernetes (K8s), <strong>I’m actually a K8s n00b</strong> and learn it is in my to-do list. But I understand how it works and what people has to do to make it work properly and securely in a production environment. When you talk about environment <strong>lifecycle</strong>, <strong>cluster upgrades</strong> (control plane, nodes, containers), <strong>networking</strong>, <strong>identity and access management</strong>, <strong>resource wasting</strong>, <strong>internal rebilling</strong>, <strong>cluster spreading</strong> to just name a few topics… We can easily say that <strong>yes, this tool can answer most of the needs</strong> but <span style="color:red"><strong>only if you’re prepared with the extra operational tasks and responsibilities this tool require</strong></span>. My point is, don’t forget there is other solutions to run your container :).</p><p>This article can be considered as an alternative option. We will work with Azure Container Instance (ACI) and Azure function. I will demonstrate a recent idea to execute various workflows without too much configuration overhead. During the last article, I’ve explained I need to run scripts that can exceed the 10 minutes limit that Azure Function with consumption SKU has, therefore ACI becomes a perfect fit. Now if we use Azure function to orchestrate your container groups, <strong>how do you manage the state of your variables between all steps</strong>?</p><p>Serverless is stateless, sadly when you have more than one step in your worflow (like step3 depends on step2 which depends on step1) you have to store your state somewhere like a database. But in my case, where I only need to run scripts, I’m only interested in passing variables from one step to another easily and dynamically <strong>without extra infrastructure</strong>.</p><p>As usual, this article will use Powershell and I assume the concept can be re-used with other languages.</p><div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Important:</b> This demo code is not production ready, here I just want to explain the concept without going to deep.</div><p>The goal of this article will be to demo a way to execute scripts in a modular manner where all scripts can use the same “concept” without worrying about infrastructure, management, or operation overhead…</p><h1 id="implementation">Implementation</h1><p>The solution look like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/aciv1.png" alt="Desktop View" /></p><ol><li>Is the initial phase where we basically define our dataset of variables we will pass to our pipeline and store in a queue. In addition, we can imagine another Az function with timer trigger which will call the HTTP or you can also replace the HTTP one by the timer one if you don’t need external interaction or body parameter.<li>Is when the Az function is triggered by the previous step. Implementing async method like this make our solution more flexible and scalable.<li>Is when a function will ask the ARM fabric to deploy our ACI with a container hosted in a Container Registry (ACR). Once deployed, our container will do his job…<li>Is once the work is done, the container will contact another Az function to store variables in a second queue to keep our variables for next a later step.<li>Is finally when we ask the fabric to clean the container group.</ol><p>Let’s deploy this solution and provide explanations for each step to explain how everything works…</p><p>As usual, the code will be available on Github <a href="https://github.com/SCOMnewbie/Azure/tree/master/ACI/Simple_Deployment">HERE</a>.</p><h2 id="resource-groups-rg">Resource Groups (RG)</h2><p>We will need two RGs. The <strong>management one which will oversee the orchestration part</strong> (control plane). And the <strong>deployment RG which will basically host all our container groups</strong> (data plane). The big difference between the two (except the infra of course) is that our Az function will have contributor access on the deployment one and reader to the control plane. I consider this as a safety net and of course the contributor role can be tweaked to be more granular if needed.</p><h2 id="function-app">Function App</h2><p>The function app is the angular stone of this idea, we will use it as the orchestrator. Let’s create a <strong>consumption Powershell based function app and then enabled the system managed identity</strong>. Now that our function has a proper identity, let’s <strong>grant it reader role to the management RG and contributor to the deployment RG</strong>.</p><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Instead of contributor, you can fine-grained the RBAC with custom roles.</div><p>To avoid duplicating code between functions, I’ve created a simple <strong>module called loadme</strong> where we will find all functions we will re-use over and over. Thanks to the portal, it’s easy to add this module to our function app. On the <strong>App Service Editor</strong> menu and the click <strong>Go</strong>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/01.png" alt="01" /></p><p>Now you can easily <strong>create the required Modules folder</strong> and then <strong>drag and drop the loadme module files</strong> like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/02.png" alt="02" /></p><p>At this point, all functions located under this function app will be available to be called.</p><p>Now under App files (left menu), make sure your <strong>profile.ps1</strong> looks like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/03.png" alt="03" /></p><p>And the <strong>requirements.psd1</strong> like that:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/04.png" alt="04" /></p><p>At this point, our functions will be able to read/write into our resource groups. In addition, we’re now prepared to connect to Azure with the Az.Accounts module, deployed to it with the Az.Resources module and finally use our own custom code with the loadme one! <strong>We will come back later to this function app to create the functions themselves</strong>…</p><h2 id="user-managed-identity-user-msi">User managed Identity (User MSI)</h2><p>Because we will <strong>create and delete our container group(s) all the time</strong>, if we decide to use a <strong>system managed identity</strong> for our ACI, we will quickly mess up our RBAC table with things like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/05.png" alt="05" /></p><p>To avoid this, we will create a <strong>user MSI that our ACI will use during the deployment</strong>. Let’s now create it. <strong>Once done, let’s assigned our previously created function app the role Managed identity operator on the user MSI resource itself</strong>. Effectively, the inherited reader access does not grant enough permission when the function app will deploy our ACI with this user MSI identity.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/06.png" alt="06" /></p><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> For the person(s) still with me, this User MSI part is not really mandatory. It is because our Template Specs will require it, but long story short we will use it in the next article…</div><h2 id="template-specs">Template specs</h2><p>I won’t be kind in this section. My first plan was to use the CLI but it’s not efficient to bring it into our Az function runtime. Then, <strong>I’ve tried the Az.ContainerInstance Powershell module which is, sorry to say this, the worse Powershell module that I’ve seen</strong>. Nothing is working, the doc is inaccurate, some cmdlets does not even work, I’m surprised that this module went through testing phases …</p><p>The last choice that I had was in fact to deploy an ARM template directly. But if I don’t want to store a state in a database, do you think I want to store an ARM template in a storage account? This is where <strong>Template specs start to shine</strong>. The setup is simple, you create a resource called template specs, and paste the content of the <strong>ACI.json</strong> file. This is a custom template that I’ve quickly created for this proof of concept where we have to specify a User MSI for later usage.</p><h2 id="container-registry-acr">Container Registry (ACR)</h2><p>Nothing complicated here, create an ACR and sadly make sure the <strong>admin credentials are enabled</strong> … I know it sucks but I didn’t find a way to use Azure AD credentials to fetch a container image.</p><p>Because reader role is not enough again, I’ve granted <strong>contributor role on the ACR resource itself to our function app</strong>. For fine grained RBAC, we have to use custom role again…</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/07.png" alt="07" /></p><h3 id="container">Container</h3><p>Instead of building it locally with Docker and send it to the ACR, we will ask the ACR to build it for us. Let’s connect to our ACR with our AAD creds (Docker desktop and Az CLI are required):</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/acrlogin.png" alt="acrlogin" /></p><p>Change directory in the Docker folder and then type:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/acrupload.png" alt="acrupload" /></p><p>We should now have a new image called demo/demoacivariable:v1 in our ACR, let’s verify:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/acruploaddone.png" alt="acruploaddone" /></p><p>At this point, most of the infrastructure is done. We will now create our various functions that we will host on our function app and explain each of them. Then we will finish to explain what the container is doing.</p><h2 id="az-functions">Az functions</h2><h3 id="the-initjob">The initJob</h3><p>All functions we will add to our function app can be found <a href="https://github.com/SCOMnewbie/Azure/tree/master/ACI/Simple_Deployment/AzFunction">here</a>.</p><p>As the name suggest, this is the starting point. This is where we will configure all variables we will consume during the pipeline. In addition to both calculated and hardcoded variables, the HTTP trigger give us the possibility to add information from the requester through body or query parameters. The main idea with this function is that it’s <strong>the only place where you define your variables for the whole pipeline</strong>.</p><p>This function has 2 output bindings. HTTP to give a state back the requestor to propose error control and the queue one because we have to drop our variables somewhere…</p><p>Here an example:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/bindings.png" alt="bindings" /></p><div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Important:</b> No secret should be stored in this hashtable. An option can be a Keyvault reference like we will see later.</div><h3 id="dqinitjob">DQinitjob</h3><p>This second function will be triggered by the message added in the initjob queue. This Az function will use custom functions located in the loadme module.</p><p>Starting from this function, <strong>no variable should be set manually anymore except the ones you don’t want to pass to the next step</strong>. We only consume what is coming from the previous job (initjob in this case). The <strong>New-VariableFactory</strong> function takes a hashtable as a parameter and create variables with the same name/value in the session. In other words, <strong>if you have a key called __<em>runId with the value ‘ABC’ in the initjob, this function will create a variable called $</em>__runId with the value ‘ABC’ in your current Powershell session</strong>.</p><p>Because our function app has an identity and a contributor role applied to the ACR, we will be able to fetch an access token for the https://management.azure.com/ resource that we will use to extract the ACR admin credentials <strong>without using any password</strong>!</p><p>With ACI, you can expose environment variables to your container group if you follow a specific format. Now, <strong>because we don’t share secrets</strong>, <strong>why not simply expose everything to our container</strong>? This is where the function <strong>New-ACIEnvGenerator</strong> comes into place and where the “naming convention” starts to make sense. This function will take all keys from the initjob and format them to be consumed by the container.</p><p>Here for example, we create new “formatted” variable ($envVars) that will contain all current session variables which are starting with our prefix.</p><pre><code class="language-Powershell">
$EnvVars = New-ACIEnvGenerator -Variables $(Get-Variable -Name '___*' ) # our prefix

</code></pre><p>Then, we just deploy container group with a big splatting:</p><pre><code class="language-Powershell">
$splatting = @{
    Name = $___ContainerName
    ResourceGroupName = $___ACIRG
    TemplateSpecId = $___ACITemplateSpecId
    ContainerName = $___ContainerName
    ImageName = $___Imagename
    EnvironmentVariables = $EnvVars
    imageRegistryCredentialsServer = $___ACRNameFullName
    imageRegistryCredentialsUsername = $($ACRInfo.Username)
    imageRegistryCredentialsPassword = $(ConvertTo-SecureString $($ACRInfo.passwords[0].value) -AsPlainText)
    UserMSIResourceId = $___UserMSIResourceId
}
# Deploy the ACI from template specs
New-AzResourceGroupDeployment @splatting

</code></pre><p>As you can see, in less than 10 lines of code, we <strong>get an access token</strong>, <strong>fetch ACR credential</strong>, <strong>expose dynamic environment variables</strong> to our container and finally <strong>deploy</strong> it!</p><p>Once the ACI is created, we can check the exposed environment variables:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/08.png" alt="08" /></p><p>And the container logs:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-08-29/09.png" alt="09" /></p><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> A good idea should be to extract logs send them to a storage blob or something else but it’s not the scope of this article.</div><p>Our container will run once the ACI is deployed but … What our container is doing? For now, this is a <strong>demo script</strong> (DemoACIScript.ps1) so we just display the current environment variables, create a new variable which start with our prefix convention. This is where the function <strong>New-HashtableFactory</strong> is interesting. We basically <strong>create a hashtable with all variables which start with a prefix in our session</strong>. Then we simply send this hashtable to another Azure function with the hashtable as a payload.</p><p>The idea with this container is simple. <strong>You always have something to do and you always want to notify something/someone when the job is done</strong>. Now, because we can have more/less data to share to a later step, re-using the dynamic prefixed variables idea help us to <strong>circle back the information</strong>.</p><h3 id="stage2-im-really-bad-in-naming-">Stage2 (I’m really bad in naming …)</h3><p>This function just helps us to store the hashtable which comes from the container once the job is done to another queue.</p><h3 id="removeinfra">RemoveInfra</h3><p>This final function is triggered by the <strong>message posted by the stage2 function</strong> into a second queue. <strong>The message contains all variables from the initjob AND the new variable we’ve added from the container</strong>. With this function, as before, we <strong>re-hydrate</strong> all variables in memory, and then simply <strong>destroy our container group</strong> in this case.</p><p>Why do we want to remove our infrastructure?</p><ul><li>You update your container image, you’re sure you use the latest image everytime.<li>You need to pass new environment variables.<li>Cleaner resource group helps for my peace of mind …</ul><h2 id="things-to-keep-in-mind">Things to keep in mind</h2><p>As you’ve seen, in term of <strong>responsibility, we let the cloud provider manage almost everything</strong>. We’re only responsible of the orchestration with the Az func and to keep our container up to date. In fact, we can even ask Azure to keep our container up to date automatically with ACR tasks.</p><p>Now it’s not because you have less responsibilities to manage that there is nothing to do, here what I have in mind to improve the idea:</p><ul><li>Several has to be monitored, here some ideas:<ul><li>Poison’s queues<li>ACI deletion fail<li>Number of runs per day with Azure monitor</ul><li>Download the ACI logs (from your container) and upload it somewhere before we delete the infrastructure.<h1 id="conclusion">Conclusion</h1></ul><p>During this article, we’ve seen a way to deploy and orchestrate container(s) easily without a lot of configurations overhead. Effectively, using PaaS products allow us to mainly focus on what we want to run and not what we have to do to make our code to run effectively and securely. In the next article we will add more Azure AD topics to see how we can rely on Keyvault to pass secrets! See you in the next one.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/powershell/'>powershell</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/powershell/" class="post-tag no-text-decoration" >Powershell</a> <a href="/tags/container/" class="post-tag no-text-decoration" >Container</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Kubernetes is not the only way... - SCOMnewbie learnings&url=https://scomnewbie.github.io//posts/acifactory/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Kubernetes is not the only way... - SCOMnewbie learnings&u=https://scomnewbie.github.io//posts/acifactory/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Kubernetes is not the only way... - SCOMnewbie learnings&url=https://scomnewbie.github.io//posts/acifactory/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/usegraphapibatching/">Use Graph API batching to speed things up?</a><li><a href="/posts/adqueriesfromazure/">Execute AD queries protected by modern authentication from Azure without VPN</a><li><a href="/posts/createaadapplications/">Another way to create Azure AD applications</a><li><a href="/posts/passwordlesswitharc/">Passwordless deployment from anywhere with Azure ARC</a><li><a href="/posts/registrationvsenterpriseapp/">Deep dive into modern application</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/identity/">identity</a> <a class="post-tag" href="/tags/aad/">AAD</a> <a class="post-tag" href="/tags/azuread/">AzureAD</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/cli/">CLI</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/devops/">Devops</a> <a class="post-tag" href="/tags/graph/">Graph</a> <a class="post-tag" href="/tags/graphapi/">GraphAPI</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/passwordlesswitharc/"><div class="card-body"> <span class="timeago small" > Feb 19 <i class="unloaded">2021-02-19T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Passwordless deployment from anywhere with Azure ARC</h3><div class="text-muted small"><p> Introduction Instead of re-inventing the wheel, I will simply paste this definition that I’ve found in the Azure ARC overview. “Azure Arc enables you to manage your entire environment, with a sing...</p></div></div></a></div><div class="card"> <a href="/posts/passwordlessongithub/"><div class="card-body"> <span class="timeago small" > Feb 28 <i class="unloaded">2021-02-28T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Concrete passwordless Github pipeline with ARC for servers</h3><div class="text-muted small"><p> Introduction In the previous article, I’ve explained what I did with ARC and this time, I’ve wanted to go deeper. Few month ago, I’ve played with Azure DevOps (AzDO). You can find my shift left mi...</p></div></div></a></div><div class="card"> <a href="/posts/createaadapplications/"><div class="card-body"> <span class="timeago small" > Mar 24 <i class="unloaded">2021-03-24T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Another way to create Azure AD applications</h3><div class="text-muted small"><p> Introduction I’m still enjoying learning AAD identity topics. In the previous articles, I’ve explained the differences between app registration and Enterprise app. Since I’ve started this learning...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/usegraphapibatching/" class="btn btn-outline-primary"><p>Use Graph API batching to speed things up?</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/fanfleon">Francois LEON</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/identity/">identity</a> <a class="post-tag" href="/tags/aad/">AAD</a> <a class="post-tag" href="/tags/azuread/">AzureAD</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/cli/">CLI</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/devops/">Devops</a> <a class="post-tag" href="/tags/graph/">Graph</a> <a class="post-tag" href="/tags/graphapi/">GraphAPI</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://scomnewbie.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
