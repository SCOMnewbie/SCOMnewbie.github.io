<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="How to use modern authentication" /><meta name="author" content="Francois LEON" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://scomnewbie.github.io//posts/howtousemodernauth/" /><meta property="og:url" content="https://scomnewbie.github.io//posts/howtousemodernauth/" /><meta property="og:site_name" content="SCOMnewbie learnings" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-09T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to use modern authentication" /><meta name="twitter:site" content="@fanfleon" /><meta name="twitter:creator" content="@Francois LEON" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Francois LEON"},"description":"Introduction","url":"https://scomnewbie.github.io//posts/howtousemodernauth/","@type":"BlogPosting","headline":"How to use modern authentication","dateModified":"2021-06-09T00:00:00+02:00","datePublished":"2021-06-09T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://scomnewbie.github.io//posts/howtousemodernauth/"},"@context":"https://schema.org"}</script><title>How to use modern authentication | SCOMnewbie learnings</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-7JY58BKWDR"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-7JY58BKWDR'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">SCOMnewbie learnings</a></div><div class="site-subtitle font-italic">A text-focused Jekyll theme</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/SCOMnewbie" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/fanfleon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['francois.leon','hotmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG ‚Ä∫ <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>How to use modern authentication</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>How to use modern authentication</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jun 9, 2021, 12:00 AM +0200" > Jun 9 <i class="unloaded">2021-06-09T00:00:00+02:00</i> </span> by <span class="author"> Francois LEON </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2235 words">12 min</span></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>I‚Äôm learning modern authentications since several months and I still learn new things every day! I‚Äôm super happy to publicly share what I‚Äôm doing on my free time and I hope it will help some of you to <strong>better understand how modern authentication is working</strong>. In the past months, I‚Äôve created several articles to explain what modern authentication is. This time we will <strong>make it real</strong> and we will use two modules that I‚Äôve released few weeks ago. The first one to create AAD apps (useful for multi tiers apps) which can be downloaded <a href="https://github.com/SCOMnewbie/PSAADApplication">here</a> or you can read my previous <a href="https://scomnewbie.github.io/posts/createaadapplications">post</a> for more information. And a module called <strong>psoauth2</strong> which will help us to interact and learn modern authentication with AAD. You can find the module <a href="https://github.com/SCOMnewbie/psoauth2">here</a> and in fact this is the masterpiece of this initiative.</p><div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Important:</b> This module has been created to help people to better understand modern auth. My advice is to use the MSAL.PS module if you want to use Powershell for production workload. I will propose few examples with MSAL.PS soon. Yeah I know it‚Äôs weird to tell you to not use a module on which I‚Äôve spent 2 months to build‚Ä¶</div><p>When I‚Äôve started to work on modern auth with Powershell, I only wanted to execute graph queries from my scripts. I have to admit the online available resources weren‚Äôt great at that time (client_credential is not the only flow you can use). This is when I decided to create something to explain my understandings to people.</p><p>Now, to be honest <strong>Powershell is not where you will be able to get the full benefit of the identity platform (AAD)</strong> but PosH is good for demos and debugging. Some more ‚Äúadvanced‚Äù language better interacts with the platform (dynamic consent, identity.web library and asp.net, conditional access context auth request, ‚Ä¶). Does it mean we can‚Äôt learn how modern authentication is working with Powershell? Nnnnaaahhhh.</p><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> <strong>I will update this article over time.</strong> It takes a lot of time to build those demos (even more for advanced ones) and to put everything ‚Äòon paper‚Äô.</div><p>Finally, those modules as provided as-is without warranty üòä.</p><p>Let‚Äôs have fun!</p><p>This initiative will propose:</p><ul><li>To use Powershell mainly to explain how to play with AAD.<li>Several demos where each demo tries to focus on a specific topic<li>A lot of tips through comments into the code (in the module or through the examples)<li>A module created to learn oauth/OIDC.</ul><p>This initiative won‚Äôt propose:</p><ul><li>To explain what identity is from scratch. Read my previous articles of follow the <a href="https://www.twitch.tv/425show">425 show</a> for more information.<li>To explain how to use a Powershell module. Ask if you need help.</ul><p>Why did I start this initiative?</p><ul><li>Because modern auth is not a simple topic but it‚Äôs not so complicated when you understand how it‚Äôs working. Thanks to Microsoft.<li>Because a lot of co-workers struggle with the subject (dev or IT).<li>Because I wanted to give a little contribution and spending some time to write things.<li>Because Powershell does not have a lot of published articles around modern authentication.</ul><h1 id="work-done">Work done</h1><p>This module provides 7 commands:</p><ul><li>New-Accesstoken<ul><li>Manage a <strong>local cache</strong> for access token, refresk tokens, Id Tokens, secrets for both Windows and Linux.<li>Propose several flows:<ul><li><strong>Device code flow</strong><li><strong>Client_credential flow</strong> with both secrets and certs<li><strong>Auth code flow with PKCE</strong> with or without secret</ul><li>Manage <strong>refresh token when access token is expired</strong> (No interaction)</ul><li>Clear-tokenCache to simply remove the local cache<li><strong>Revoke-RefreshTokens</strong> to ask AAD to invalidate all current refresh tokens that has been generated before for a user.<li>Test-AADToken which <strong>validate if a token is valid or not</strong>. We will use this function later once we will play with advanced concepts.<li><strong>ConvertFrom-Jwt</strong> to decode the JWT with header,payload and signature. I had to make this command public because I will use it later with Azure functions.<li>New-APIOnBehalfToken to call the <strong>On Behalf Of flow</strong>. This command is public because Azure functions do not like my caching method that I use with New-Accesstoken.<li>New-APIServerToServerToken which is a basic client credential but again without caching for the same reason above.</ul><h1 id="work-to-do">Work to do</h1><ul><li>Auth code PKCE with certs<li>Create multi tier demos with advanced concepts<li>Add MSAL.PS examples<li>Create a C# desktop app (I already have a good usecase‚Ä¶. Now I need to learn C# lol)<li>I may add my MSI Azure ARC command in this module too later.</ul><h1 id="how-to-use-this-module">How to use this module</h1><p>There is two important parts:</p><ul><li>In the <strong>psoauth2\psoauth2 folder</strong>, you will be able to find the latest usable Powershell module. I don‚Äôt think it‚Äôs a good idea to expose this module though the PS Gallery (not prod ready).<li>In the <strong>examples folders</strong>, you will be able to find <strong>multiples demos</strong> where I explain different aspects of what modern auth is and how you can use it. Over time, I will fill this folder with more cases (multi-tiers app) and with other languages too.</ul><div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Don‚Äôt forget to use your TenantId/SubscriptionId if you want to play with the demos (always on top of the script)</div><p>I recommend to simply follow demos in order.</p><h1 id="prerequisites">Prerequisites</h1><ul><li>You will need Global admin permission to run those demos (admin consent). You can request a dev AAD environment for free <a href="https://developer.microsoft.com/en-us/microsoft-365/dev-program">here</a>.<li>You will need to use the PSAADApplication module. You can find it in the Example folder or directly <a href="https://github.com/SCOMnewbie/PSAADApplication/tree/main/PSAADApplication/PSAADApplication">here</a> for the latest version.<li>You will need the AZ module and/or the AZ CLI too (for certs demos).<li>In some demos, you will need an <strong>active subscription</strong> with a Keyvault already created.<h1 id="basic-usecases">Basic usecases</h1></ul><p>The simple usecases will contain examples with only one tier. For now it‚Äôs only Powershell, but later I plan to use other langages.</p><h2 id="confidential-app-with-secret-for-subscription-role-assignment">Confidential app with secret for subscription role assignment</h2><ul><li><p>Script is located <a href="https://github.com/SCOMnewbie/psoauth2/blob/main/Examples/01-Script-ConfApp-Secret-AzureAssignment.ps1">here</a>.</p><li>Takeaways:<ul><li>Simple to implement (dev/test)<li>Make sure you implement a key/secret rotation in your application to avoid expiration (Event based notification)<li>No user assignation with this method<li>AAD audit logs can be challenging. You don‚Äôt know the user context, the task run as an application.<li>You have to store your secret somewhere (not committed in plaintext in your repo)</ul><li>Picture of what we will do:</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-06-09/01.png" alt="01" /></p><h2 id="confidential-app-with-certificate-for-subscription-role-assignment">Confidential app with certificate for subscription role assignment</h2><ul><li><p>Script is located <a href="https://github.com/SCOMnewbie/psoauth2/blob/main/Examples/02-Script-ConfApp-Cert-AzureAssignment.ps1">here</a>.</p><li>Takeaways:<ul><li>Certificates are better than secrets when you have a good certificates hygiene in your company. Secrets are catched by proxies or other auditing tools, certificates no.<li>Certificates is more complicated to implement than secrets but it‚Äôs not impossible. My current user experience is really not optimal for now (more info in the script file). Microsoft should work on this part to make it more accessible.<li>Make sure you implement a key/secret rotation in your application to avoid expiration (Event based notification)<li>No user assignation with this method too<li>AAD audit logs can be challenging<li>Keep your private key safe<li>Use <strong>pem</strong> KV policy is you plan to use CLI or from a Linux box</ul><li>Picture of what we will do:</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-06-09/02.png" alt="02" /></p><h2 id="confidential-app-with-secret-to-call-graph-api">Confidential app with secret to call graph API</h2><ul><li>Script is located <a href="https://github.com/SCOMnewbie/psoauth2/blob/main/Examples/03-Script-ConfApp-Secret-Application-GraphAPI.ps1">here</a>.<li>Takeaways:<ul><li>This is what you see everywhere on Internet.<li>We need the TeanantId as a new information to provide. We will use exclusively <strong>single tenant app</strong> for now.<li>This request will be executed as an application permission (will have access to all tenant resources)<li>Secret should stay protected<li>Now it‚Äôs not just CLI or Powershell. You can do this with multiple runtimes. You can find Microsoft libraries <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-v2-libraries">here</a> or any certified OIDC libraries <a href="https://openid.net/developers/certified/">here</a>. The concept is still the same.<li>We will use the Graph beta endpoint (following a friends need), but use the V1.0 in production, not the Beta version.</ul><li>Picture of what we will do:</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-06-09/03.png" alt="03" /></p><h2 id="confidential-app-with-cert-to-call-graph-api">Confidential app with cert to call graph API</h2><ul><li>Script is located <a href="https://github.com/SCOMnewbie/psoauth2/blob/main/Examples/04-Script-ConfApp-Cert-GraphAPI.ps1">here</a>.<li>Takeaways:<ul><li>Client credential flow should be used to server to server (no user interraction).<li>Because there is no interraction (and so no dynamic scope consent), <strong>.default</strong> scope has to be use.<li>New-AccessToken with ClientCredentialFlow parameter (psoauth2 module cmdlet) can be used to generate an access token and keep it locally into cache (should work on Linux machine too)<li>psoauth2 module manage local token caching.<li>When you use cert auth, you end up create a custom JWT, you use your local private key to sign the token and on the other side, AAD will decode it with the public one. This is called an assertion.<li>it‚Äôs doesn‚Äôt matter if you commit the thumbprint.<li>use pfx KV policy if you plan to use the cert from Windows.</ul><li>Picture of what we will do:</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-06-09/04.png" alt="04" /></p><h2 id="public-app-with-no-secret-delegated-permission-to-call-graph-api-auth-code-flow-with-pkce--device-code">Public app with NO SECRET delegated permission to call graph API (Auth code flow with PKCE + Device Code)</h2><p>Context:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Now the fun really begins. Having over-privileged API that you use with secrets/certs is cool (application permission), but the real benefit of modern authentication is the delegated permission part where you don't need any secrets. The platform will use the permission you have as user and act on behalf of you. In other words, if you can't do things with your account, you won't be able to do it through the API (delegated permissions). In the demo, we will create a public app (no secret/cert), require assignment on it (people have to be assigned to authenticate to it) and as before (with a right scope this time) request privilege action from graph (write user auth methods in the demo and remove user account from the picture).
</pre></table></code></div></div><ul><li>Script is located <a href="https://github.com/SCOMnewbie/psoauth2/blob/main/Examples/05-Script-Public-Delegated-GraphAPI.ps1">here</a>.<li>Takeaways:<ul><li>Public application does mean you add more ways to authenticate to your application. For example device code flow or ROPC flow (don‚Äôt use it‚Ä¶).<li>You don‚Äôt necessary need a secret to use modern authentication.<li>Auth Code with PKCE should be the way to go first (even for confidential apps). We will use the New-AccessToken cmdlet.<li>We will use the device code flow too (with the New-AccessToken cmdlet)<li>The request will run with a delegated permission (on behelf of user privileges)<li>We can assign who can access our app now (in comparison to the client credential flow)<li>Don‚Äôt forget to read comments even on the verbose lines (lot of useful information)<li>Now in AAD logs, you will see user ABC did XYZ action trough application AppID. In means that if you‚Äôre a Global admin, you will be able to do GA stuff without commiting any secrets!<li>With user assignment, you can even say, GA1 can use the resource X but not resource Y. (we do the test in the demo)</ul><li>Picture of what we will do:</ul><p>In the demo we‚Äôre are just talking about Global admins accounts (2 differents accounts), but in the picture we‚Äôre adding 2 regular users accounts too. The idea of this picture is to explain what delegated permission is. To be able to call your API (at least in this demo), you has to be first allowed to request a token (user assignment) and then you have to have the permission to do an action with your account. In other words, in this picture, only User account A which is global admin will be able to deactivate a user account.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-06-09/05.png" alt="04" /></p><h2 id="public-app-delegated-permission-with-refresh-token">Public app delegated permission with refresh token</h2><p>Being able to call our API with delegated permission is cool, but do I have to authenticate every hours to my application? This is where refresh token comes into place. The goal of this demo will be to explain how you can get an access token. As before, read the demo file to have deeper information.</p><ul><li>Script is located <a href="https://github.com/SCOMnewbie/psoauth2/blob/main/Examples/06-Script-Public-Delegated-GraphAPI-RefreshToken.ps1">here</a>.<li>Takeaways:<ul><li>All authentication flows do not generate an refresh token. For exemple client credential don‚Äôt.<li>openid scope allow your app to receive an Id token. This scope is like adding [cmdletbinding] to your function to then be able to use offline_access and so on‚Ä¶<li>offline_access is the scope you have to configure to receive a refresh token<li>Use the oid + sub claim to generate a unique id for a use between all tenants. The profile scope add those claims (check the demo).<li>To play with the refresh token, you will simply use the same command New-AccessToken but only when your access token will be expired (add verbose)<li>Funny usage of the PSAADApplication module where I will create 5 pre-configured applications with a ‚Äúsimple‚Äù swich statement.<li>You can add other claims in the token you will receive in both the Id and Access Token. Check out the joker application (optionalClaims).</ul></ul><h1 id="advanced-usecases">Advanced usecases</h1><h2 id="multi-tiers-applications-frontend-with-backend-api">Multi-tiers applications (frontend with backend api)</h2><ul><li>You have all information in this <a href="https://scomnewbie.github.io/posts/protectbackendapi/">article</a>.<li>Takeaways:<ul><li>Even if our <strong>frontend</strong> does not have secret, we‚Äôre still be able to configure the AAD app as a <strong>confidential app</strong> to accept only one authentication flow which is the auth code flow here.<li><strong>App role</strong> exist within an app. It‚Äôs a good solution to <strong>implement authorization</strong> within your app. Just look at the roles claims in the token from your api.<li><strong>The API is responsible</strong> of validating both the <strong>token</strong> AND the <strong>authorization</strong>.<li><strong>Easy Auth</strong> is cool to <strong>protect your exposed api</strong> without any effort ‚Äúfor free‚Äù. You need a <strong>better protection</strong>, use service like <strong>APIM</strong>.<li>If you plan to expose your single tenant backend API to only a set of users, don‚Äôt forget to enabled the the <strong>user assignment required</strong> under the properties menu (Enterprise app)</ul></ul><h1 id="conclusion">Conclusion</h1><p>I hope this article has been useful, don‚Äôt hesitate to contact me on Twitter/Github if you have question or concerns, I‚Äôm always open to feedbacks.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/identity/'>identity</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/identity/" class="post-tag no-text-decoration" >identity</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >Powershell</a> <a href="/tags/aad/" class="post-tag no-text-decoration" >AAD</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How to use modern authentication - SCOMnewbie learnings&url=https://scomnewbie.github.io//posts/howtousemodernauth/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How to use modern authentication - SCOMnewbie learnings&u=https://scomnewbie.github.io//posts/howtousemodernauth/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=How to use modern authentication - SCOMnewbie learnings&url=https://scomnewbie.github.io//posts/howtousemodernauth/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/usegraphapibatching/">Use Graph API batching to speed things up?</a><li><a href="/posts/adqueriesfromazure/">Execute AD queries protected by modern authentication from Azure without VPN</a><li><a href="/posts/createaadapplications/">Another way to create Azure AD applications</a><li><a href="/posts/passwordlesswitharc/">Passwordless deployment from anywhere with Azure ARC</a><li><a href="/posts/registrationvsenterpriseapp/">Deep dive into modern application</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/identity/">identity</a> <a class="post-tag" href="/tags/aad/">AAD</a> <a class="post-tag" href="/tags/azuread/">AzureAD</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/cli/">CLI</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/devops/">Devops</a> <a class="post-tag" href="/tags/graph/">Graph</a> <a class="post-tag" href="/tags/graphapi/">GraphAPI</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/apiwithpode/"><div class="card-body"> <span class="timeago small" > Jul 7 <i class="unloaded">2021-07-07T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Build a Powershell API with Pode</h3><div class="text-muted small"><p> Introduction I‚Äôve tried to explain previously how to secure a backend api where I‚Äôve used Azure functions to demonstrate how to protect it, but what if we‚Äôre not on Azure? I know you can run the A...</p></div></div></a></div><div class="card"> <a href="/posts/adqueriesfromazure/"><div class="card-body"> <span class="timeago small" > Jul 28 <i class="unloaded">2021-07-28T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Execute AD queries protected by modern authentication from Azure without VPN</h3><div class="text-muted small"><p> Introduction I have this question in mind since several months‚Ä¶ What would I do if I wanted to run Active Directory (AD) queries from Azure without a VPN gateway? Basically, I wanted to do a quick...</p></div></div></a></div><div class="card"> <a href="/posts/createaadapplications/"><div class="card-body"> <span class="timeago small" > Mar 24 <i class="unloaded">2021-03-24T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Another way to create Azure AD applications</h3><div class="text-muted small"><p> Introduction I‚Äôm still enjoying learning AAD identity topics. In the previous articles, I‚Äôve explained the differences between app registration and Enterprise app. Since I‚Äôve started this learning...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/createaadapplications/" class="btn btn-outline-primary"><p>Another way to create Azure AD applications</p></a> <a href="/posts/protectbackendapi/" class="btn btn-outline-primary"><p>Play with multitier AAD applications</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> ¬© 2021 <a href="https://twitter.com/fanfleon">Francois LEON</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/identity/">identity</a> <a class="post-tag" href="/tags/aad/">AAD</a> <a class="post-tag" href="/tags/azuread/">AzureAD</a> <a class="post-tag" href="/tags/arc/">ARC</a> <a class="post-tag" href="/tags/cli/">CLI</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/devops/">Devops</a> <a class="post-tag" href="/tags/graph/">Graph</a> <a class="post-tag" href="/tags/graphapi/">GraphAPI</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://scomnewbie.github.io/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
